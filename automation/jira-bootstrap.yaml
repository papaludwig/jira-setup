---
schemaVersion: '0.3'
description: Run Ansible on a stack-managed EC2 instance and return stdout/stderr

parameters:
  StackName:
    type: String
  AnsibleS3Bucket:
    type: String
  AnsibleS3Key:
    type: String
  AnsibleUser:
    type: String
    default: ansible
  JiraDownloadUrl:
    type: String
  JiraDbPassword:
    type: String
  JiraTlsCertB64:
    type: String
  JiraTlsKeyB64:
    type: String

mainSteps:
  - name: DescribeStack
    action: aws:executeAwsApi
    inputs:
      Service: cloudformation
      Api: DescribeStacks
      StackName: '{{ StackName }}'
    outputs:
      - Name: Stacks
        Selector: $.Stacks
        Type: MapList

  - name: ExtractInstance
    action: aws:executeScript
    inputs:
      Runtime: python3.11
      Handler: get_instance
      Script: |-
        def get_instance(event, _):
            for o in event.get('stack', {}).get('Outputs', []):
                if o.get('OutputKey') == 'InstanceId':
                    return {'InstanceId': str(o.get('OutputValue'))}
            raise ValueError('No InstanceId output found in the stack.')
      InputPayload:
        stack: '{{ DescribeStack.Stacks[0] }}'
    outputs:
      - Name: InstanceId
        Selector: $.Payload.InstanceId
        Type: String

  - name: BuildExtraVars
    action: aws:executeScript
    inputs:
      Runtime: python3.11
      Handler: build_vars
      Script: |-
        import json
        def build_vars(event, _):
            return {
              'ExtraVars': json.dumps({
                'jira_download_url': event['jira_download_url'],
                'jira_db_password': event['jira_db_password'],
                'jira_tls_cert_b64': event['jira_tls_cert_b64'],
                'jira_tls_key_b64': event['jira_tls_key_b64'],
                'ansible_user': event['ansible_user'],
              })
            }
      InputPayload:
        jira_download_url: '{{ JiraDownloadUrl }}'
        jira_db_password: '{{ JiraDbPassword }}'
        jira_tls_cert_b64: '{{ JiraTlsCertB64 }}'
        jira_tls_key_b64: '{{ JiraTlsKeyB64 }}'
        ansible_user: '{{ AnsibleUser }}'
    outputs:
      - Name: ExtraVars
        Selector: $.Payload.ExtraVars
        Type: String

  - name: RunAnsible
    action: aws:executeAwsApi
    inputs:
      Service: ssm
      Api: SendCommand
      DocumentName: AWS-RunAnsiblePlaybook
      InstanceIds:
        - '{{ ExtractInstance.InstanceId }}'
      Parameters:
        SourceType: ['S3']
        SourceInfo: ['{"path":"https://s3.amazonaws.com/{{ AnsibleS3Bucket }}/{{ AnsibleS3Key }}"}']
        InstallDependencies: ['True']
        PlaybookFile: ['playbooks/site.yml']
        InventoryFile: ['inventory/hosts.ini']
        ExtraVariables: ['{{ BuildExtraVars.ExtraVars }}']
    outputs:
      - Name: CommandId
        Selector: $.Command.CommandId
        Type: String

  - name: WaitForCommand
    action: aws:waitForAwsResourceProperty
    inputs:
      Service: ssm
      Api: GetCommandInvocation
      CommandId: '{{ RunAnsible.CommandId }}'
      InstanceId: '{{ ExtractInstance.InstanceId }}'
      PropertySelector: '$.Status'
      DesiredValues: ['Success']

  # Discover the plugin name SSM used on the instance (avoids guessing)
  - name: DiscoverPlugin
    action: aws:executeAwsApi
    inputs:
      Service: ssm
      Api: ListCommandInvocations
      CommandId: '{{ RunAnsible.CommandId }}'
      InstanceId: '{{ ExtractInstance.InstanceId }}'
      Details: true
    outputs:
      - Name: PluginName
        Selector: $.CommandInvocations[0].CommandPlugins[0].Name
        Type: String

  # Fetch stdout/stderr from the discovered plugin
  - name: GetAnsibleOutput
    action: aws:executeAwsApi
    inputs:
      Service: ssm
      Api: GetCommandInvocation
      CommandId: '{{ RunAnsible.CommandId }}'
      InstanceId: '{{ ExtractInstance.InstanceId }}'
      PluginName: '{{ DiscoverPlugin.PluginName }}'
    outputs:
      - Name: StdOut
        Selector: $.StandardOutputContent
        Type: String
      - Name: StdErr
        Selector: $.StandardErrorContent
        Type: String
      - Name: InvocationStatus
        Selector: $.Status
        Type: String

# Document-level outputs must be an array of strings: stepName.outputName
outputs:
  - 'ExtractInstance.InstanceId'
  - 'RunAnsible.CommandId'
  - 'GetAnsibleOutput.StdOut'
  - 'GetAnsibleOutput.StdErr'
  - 'GetAnsibleOutput.InvocationStatus'
