---
schemaVersion: '0.3'
description: Run Ansible on a stack-managed EC2 instance
parameters:
  StackName:
    type: String
  Region:
    type: String
    default: "{{ global:REGION }}"
  AnsibleS3Bucket:
    type: String
  AnsibleS3Key:
    type: String
  AnsibleUser:
    type: String
    default: ansible
  JiraDownloadUrl:
    type: String
  JiraDbPassword:
    type: String
  JiraTlsCertB64:
    type: String
  JiraTlsKeyB64:
    type: String

mainSteps:
  - name: DescribeStack
    action: aws:executeAwsApi
    inputs:
      Service: cloudformation
      Api: DescribeStacks
      Region: '{{ Region }}'
      StackName: '{{ StackName }}'

  - name: ExtractInstance
    action: aws:executeScript
    inputs:
      Runtime: python3.11
      Handler: get_instance
      Script: |-
        def get_instance(event, _):
            outputs = event.get('stack', {}).get('Outputs', [])
            for o in outputs:
                if o.get('OutputKey') == 'InstanceId':
                    return {'InstanceId': str(o.get('OutputValue'))}
            raise ValueError('No InstanceId output found.')
      InputPayload:
        stack: '{{ DescribeStack.Stacks[0] }}'
    outputs:
      - Name: InstanceId
        Selector: $.Payload.InstanceId
        Type: String

  - name: BuildExtraVars
    action: aws:executeScript
    inputs:
      Runtime: python3.11
      Handler: build_vars
      Script: |-
        import json
        def build_vars(event, _):
            return {
              'ExtraVars': json.dumps({
                'jira_download_url': event['jira_download_url'],
                'jira_db_password': event['jira_db_password'],
                'jira_tls_cert_b64': event['jira_tls_cert_b64'],
                'jira_tls_key_b64': event['jira_tls_key_b64'],
                'ansible_user': event['ansible_user'],
              })
            }
      InputPayload:
        jira_download_url: '{{ JiraDownloadUrl }}'
        jira_db_password: '{{ JiraDbPassword }}'
        jira_tls_cert_b64: '{{ JiraTlsCertB64 }}'
        jira_tls_key_b64: '{{ JiraTlsKeyB64 }}'
        ansible_user: '{{ AnsibleUser }}'
    outputs:
      - Name: ExtraVars
        Selector: $.Payload.ExtraVars
        Type: String

  - name: RunAnsible
    action: aws:executeAwsApi
    inputs:
      Service: ssm
      Api: SendCommand
      Region: '{{ Region }}'
      DocumentName: AWS-RunAnsiblePlaybook
      InstanceIds:
        - '{{ ExtractInstance.InstanceId }}'
      Parameters:
        SourceType: ['S3']
        SourceInfo: ['{"path":"https://s3.amazonaws.com/{{ AnsibleS3Bucket }}/{{ AnsibleS3Key }}"}']
        InstallDependencies: ['True']
        PlaybookFile: ['playbooks/site.yml']
        InventoryFile: ['inventory/hosts.ini']
        ExtraVariables: ['{{ BuildExtraVars.ExtraVars }}']
    outputs:
      - Name: CommandId
        Selector: $.Command.CommandId
        Type: String

  - name: WaitForCommand
    action: aws:waitForAwsResourceProperty
    inputs:
      Service: ssm
      Api: GetCommandInvocation
      Region: '{{ Region }}'
      CommandId: '{{ RunAnsible.CommandId }}'
      InstanceId: '{{ ExtractInstance.InstanceId }}'
      PropertySelector: '$.Status'
      DesiredValues: ['Success']

# IMPORTANT: document-level outputs must be a list of strings (stepName.outputName)
outputs:
  - 'ExtractInstance.InstanceId'
  - 'RunAnsible.CommandId'
