---
- name: Add Corretto repo and key (Amazon Linux / RPM family)
  become: true
  block:
    - name: Import Corretto RPM signing key
      ansible.builtin.rpm_key:
        key: https://yum.corretto.aws/corretto.key
        state: present

    - name: Add Corretto yum repo
      ansible.builtin.get_url:
        url: https://yum.corretto.aws/corretto.repo
        dest: /etc/yum.repos.d/corretto.repo
        mode: "0644"

- name: Install Amazon Corretto {{ jira_java_major }} (RPM)
  become: true
  ansible.builtin.package:
    name: "java-{{ jira_java_major }}-amazon-corretto-{{ jira_java_rpm_flavor }}"
    state: present

# Discover the installed JAVA_HOME (name can include arch suffix)
- name: Discover installed Corretto JAVA_HOME
  become: true
  ansible.builtin.shell: "ls -d /usr/lib/jvm/java-{{ jira_java_major }}-amazon-corretto* 2>/dev/null | head -n1"
  args:
    warn: false
  register: corretto_home
  changed_when: false

- name: Fail if Corretto {{ jira_java_major }} not found
  ansible.builtin.assert:
    that: corretto_home.stdout != ""
    fail_msg: "Amazon Corretto {{ jira_java_major }} not found under /usr/lib/jvm."

- name: Set default 'java' alternative to Corretto {{ jira_java_major }}
  become: true
  community.general.alternatives:
    name: java
    path: "{{ corretto_home.stdout }}/bin/java"

- name: Set default 'javac' alternative when JDK is installed
  become: true
  community.general.alternatives:
    name: javac
    path: "{{ corretto_home.stdout }}/bin/javac"
  when: jira_java_rpm_flavor != 'headless'

- name: Expose JAVA_HOME system-wide for shells
  become: true
  ansible.builtin.copy:
    dest: /etc/profile.d/java_home.sh
    mode: '0644'
    content: |
      export JAVA_HOME={{ corretto_home.stdout }}
      export PATH=$JAVA_HOME/bin:$PATH

# Make JAVA_HOME easy to reuse in later roles/templates
- name: Publish JAVA_HOME for downstream roles
  ansible.builtin.set_fact:
    jira_java_home: "{{ corretto_home.stdout }}"

# Optional sanity checks
- name: Show java -version
  ansible.builtin.command: java -version
  register: java_ver
  changed_when: false

- name: Assert expected major {{ jira_java_major }}
  ansible.builtin.shell: "java -version 2>&1 | awk -F'[\\\"\\.]' '/version/ {print $2}'"
  register: jmaj
  changed_when: false

- name: Verify Java major matches requested
  ansible.builtin.assert:
    that: "(jmaj.stdout | int) == jira_java_major"
    fail_msg: "Detected Java {{ jmaj.stdout }}, expected {{ jira_java_major }}."
